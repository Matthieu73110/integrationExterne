<!DOCTYPE html>
<html>
  <head>
    <title>Tableau de bord</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      function getAddressWithLatLon(lat, lon){
        return fetch(`https://api-adresse.data.gouv.fr/reverse/?lon=${lon}&lat=${lat}`)
        .then(response => response.json())
          .then(data => {
            if (data.features.length > 0) {
              return data.features[0].properties.label;
            }
            return "No address";
          })
          .catch(error => {
            console.error("Error fetching address:", error);
            return "Error fetching address";
          });
      }
    </script>
    <style>
      #map {
        height: 600px;
      }
    </style>
  </head>
  <body>
    <h1>Bienvenue <%= username %> !</h1>
    <h2>Informations sur les stations</h2>
    <div id="map"></div>
    <h2>Itinéraires sauvegardés</h2>
    <p>Test de la fonction : <%= test() %> </p>
    <ul>
      <!-- Afficher la liste des itinéraires précédemment sauvegardés -->
      <% myItinaries.forEach(function (itinerary) { %>
      <li>
        <%= itinerary.name %>
        <p>Vous êtes allé de <%= getAddressWithLatLon(itinerary.points[0].lat, itinerary.points[0].lon) %> à <%= getAddressWithLatLon(itinerary.points[1].lat, itinerary.points[1].lon) %> </p>
        <a href="/download/pdf/<%= itinerary.id %>.pdf">Télécharger PDF</a>
      </li>
      <% }); %>
    </ul>

    <button onclick="createNewItineraire()">Créer un nouvel itinéraire</button>

    <a href="/stations"
      >Accéder à la liste des stations et leur occupation actuelle</a
    >
    <script src="js/index.js" type="text/javascript"></script>
    <script>

function test(){
    alert("ok")
  }
      
      function createNewItineraire() {
        // Logique pour créer un nouvel itinéraire
        // Rediriger vers la page de création d'itinéraire
        window.location.href = "/itineraire";
      }
      // Initialiser la carte
      var map = L.map("map").setView([48.8566, 2.3522], 15);

      // Ajouter une couche de tuiles OpenStreetMap
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // Afficher les stations sur la carte
      var stations = [<%- JSON.stringify(stations) %>];

      stations[0].forEach(function (station) {
        createMarker(station.lat, station.lon, null, station);
      });

      // // Afficher le dashboard après connexion
      // function showDashboard() {
      //   document.getElementById("dashboard").style.display = "block";
      // }

      // // Événement de clic sur le bouton "Créer un nouvel itinéraire"
      // document
      //   .getElementById("newItineraryBtn")
      //   .addEventListener("click", function () {
      //     // Afficher la carte pour créer un nouvel itinéraire
      //     map.invalidateSize();
      //     // Ici, vous pouvez ajouter le code pour enregistrer les coordonnées au clic sur la carte
      //   });

      // // Événement de clic sur le lien "Liste des stations"
      // document
      //   .getElementById("stationsLink")
      //   .addEventListener("click", function (e) {
      //     e.preventDefault();
      //     // Ici, vous pouvez ajouter le code pour afficher la liste des stations
      //   });
    </script>
  </body>
</html>
